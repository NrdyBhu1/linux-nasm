     1                                  ; Name        : aboutbox.asm
     2                                  
     3                                  ; Build       : nasm -felf64 -o aboutbox.o -l aboutbox.lst aboutbox.asm
     4                                  ;               ld -s -m elf_x86_64 aboutbox.o -o aboutbox -lc --dynamic-linker /lib64/ld-linux-x86-64.so.2 -lgtk-3 -lgobject-2.0  -lglib-2.0 -lgdk_pixbuf-2.0 -lgdk-3 -lpango-1.0 -latk-1.0 -lgio-2.0 -lpangoft2-1.0
     5                                  ;               -lpangocairo-1.0 -lcairo -lfreetype -lfontconfig  -lgmodule-2.0 -lgthread-2.0 -lrt
     6                                  ;
     7                                  ; Description : an aboutbox example
     8                                  ;
     9                                  ; Remark:
    10                                  ;   Click on the window to see the Aboutbox
    11                                  ;
    12                                  ; C - source : http://zetcode.com/tutorials/gtktutorial/gtkdialogs/
    13                                  ;              http://stackoverflow.com/questions/14121166/gdk-pixbuf-load-image-from-memory
    14                                  
    15                                  bits 64
    16                                  
    17                                  [list -]
    54                                  
    55                                  section .data
    56 00000000 <incbin>                     logo:          incbin    "logo.png"
    57                                       .size:         equ  $-logo
    58 000018C3 <incbin>                     picture:       incbin    "picture.png"
    59                                       .size:         equ  $-picture
    60                                  
    61                                       window:
    62 000093E4 0000000000000000             .handle:       dq   0
    63 000093EC 41626F757420626F78-          .title:        db   "About box example",0
    63 000093F5 206578616D706C6500 
    64                                       signal:
    65 000093FE 64657374726F7900             .destroy:      db   "destroy",0
    66 00009406 627574746F6E2D7072-          .buttonpressevent:  db   "button-press-event", 0
    66 0000940F 6573732D6576656E74-
    66 00009418 00                 
    67                                  
    68                                       dialog:
    69 00009419 0000000000000000             .handle:       dq   0
    70 00009421 41626F757420746869-          .title:        db   "About this example", 0
    70 0000942A 73206578616D706C65-
    70 00009433 00                 
    71 00009434 312E30202D2064656D-          .version:      db   "1.0 - demo", 0
    71 0000943D 6F00               
    72 0000943F 286329204167677572-          .copyright:    db   "(c) Agguro - 2015", 0
    72 00009448 6F202D203230313500 
    73 00009451 546869732069732061-          .comments:     db   "This is an example to create an about dialogbox", 0
    73 0000945A 6E206578616D706C65-
    73 00009463 20746F206372656174-
    73 0000946C 6520616E2061626F75-
    73 00009475 74206469616C6F6762-
    73 0000947E 6F7800             
    74 00009481 687474703A2F2F7777-          .website:      db   "http://www.agguro.org", 0
    74 0000948A 772E61676775726F2E-
    74 00009493 6F726700           
    75                                  
    76 00009497 0000000000000000             loader:        dq   0
    77                                       pixbuffer:
    78 0000949F 0000000000000000             .icon:         dq   0
    79 000094A7 0000000000000000             .image:        dq   0
    80                                       
    81                                  section .text
    82                                          global _start
    83                                  
    84                                  _start:
    85 00000000 4831F6                       xor       rsi, rsi                  ; argv
    86 00000003 4831FF                       xor       rdi, rdi                  ; argc
    87 00000006 E8(00000000)                 call      gtk_init
    88                                  
    89 0000000B BF00000000                   mov       rdi,GTK_WINDOW_TOPLEVEL
    90 00000010 E8(00000000)                 call      gtk_window_new
    91 00000015 48890425[E4930000]           mov       qword [window.handle], rax
    92                                  
    93 0000001D 488B3C25[E4930000]           mov       rdi, qword [window.handle]
    94 00000025 BE01000000                   mov       rsi, GTK_WIN_POS_CENTER
    95 0000002A E8(00000000)                 call      gtk_window_set_position
    96                                  
    97 0000002F 488B3C25[E4930000]           mov       rdi, qword [window.handle]
    98 00000037 BEDC000000                   mov       rsi, 220
    99 0000003C BA96000000                   mov       rdx, 150
   100 00000041 E8(00000000)                 call      gtk_window_set_default_size
   101                                  
   102 00000046 488B3C25[E4930000]           mov       rdi, qword [window.handle]
   103 0000004E 48BE-                        mov       rsi, window.title
   103 00000050 [EC93000000000000] 
   104 00000058 E8(00000000)                 call      gtk_window_set_title
   105                                  
   106 0000005D 488B3C25[E4930000]           mov       rdi, qword[window.handle]
   107 00000065 BE0F000000                   mov       rsi, 15
   108 0000006A E8(00000000)                 call      gtk_container_set_border_width
   109                                  
   110 0000006F 488B3C25[E4930000]           mov       rdi, qword[window.handle]
   111 00000077 BE00010000                   mov       rsi, GDK_BUTTON_PRESS_MASK
   112 0000007C E8(00000000)                 call      gtk_widget_add_events
   113                                  
   114 00000081 E8(00000000)                 call      gdk_pixbuf_loader_new
   115 00000086 48890425[97940000]           mov       qword [loader], rax
   116 0000008E 488B3C25[97940000]           mov       rdi, qword[loader]
   117 00000096 48BE-                        mov       rsi, logo
   117 00000098 [0000000000000000] 
   118 000000A0 BAC3180000                   mov       edx, logo.size
   119 000000A5 4831C9                       xor       rcx, rcx
   120 000000A8 E8(00000000)                 call      gdk_pixbuf_loader_write
   121                                  
   122 000000AD 488B3C25[97940000]           mov       rdi, qword[loader]
   123 000000B5 E8(00000000)                 call      gdk_pixbuf_loader_get_pixbuf
   124 000000BA 48890425[9F940000]           mov       qword[pixbuffer.icon], rax
   125                                  
   126 000000C2 488B3C25[E4930000]           mov       rdi, qword [window.handle]
   127 000000CA 488B3425[9F940000]           mov       rsi, qword [pixbuffer.icon]
   128 000000D2 E8(00000000)                 call      gtk_window_set_icon
   129                                  
   130 000000D7 4531C9                       xor       r9d, r9d                             ; combination of GConnectFlags 
   131 000000DA 4531C0                       xor       r8d, r8d                             ; a GClosureNotify for data
   132 000000DD 488B0C25[E4930000]           mov       rcx, qword[window.handle]            ; pointer to the data to pass
   133 000000E5 48BA-                        mov       rdx, show_about                      ; pointer to the handler
   133 000000E7 [7101000000000000] 
   134 000000EF 48BE-                        mov       rsi, signal.buttonpressevent         ; pointer to the signal
   134 000000F1 [0694000000000000] 
   135 000000F9 488B3C25[E4930000]           mov       rdi, qword[window.handle]            ; pointer to the widget instance
   136 00000101 E8(00000000)                 call      g_signal_connect_data                ; the value in RAX is the handler, but we don't store it now
   137                                  
   138 00000106 4531C9                       xor       r9d, r9d                             ; combination of GConnectFlags 
   139 00000109 4531C0                       xor       r8d, r8d                             ; a GClosureNotify for data
   140 0000010C 488B0C25[E4930000]           mov       rcx, qword[window.handle]            ; pointer to the data to pass
   141 00000114 48BA-                        mov       rdx, gtk_main_quit      ; pointer to the handler
   141 00000116 [0000000000000000] 
   142 0000011E 48BE-                        mov       rsi, signal.destroy     ; pointer to the signal
   142 00000120 [FE93000000000000] 
   143 00000128 488B3C25[E4930000]           mov       rdi, qword[window.handle]      ; pointer to the widget instance
   144 00000130 E8(00000000)                 call      g_signal_connect_data   ; the value in RAX is the handler, but we don't store it now
   145                                  
   146 00000135 E8(00000000)                 call      gtk_about_dialog_new
   147 0000013A 48890425[19940000]           mov       qword[dialog.handle], rax
   148                                       
   149                                       ; if we should leave next three lines we get : Gtk-Message: GtkDialog mapped without a transient parent. This is discouraged.
   150 00000142 488B3C25[19940000]           mov     rdi, qword[dialog.handle]
   151 0000014A 488B3425[E4930000]           mov     rsi, qword[window.handle]
   152 00000152 E8(00000000)                 call    gtk_window_set_transient_for
   153                                       
   154 00000157 488B3C25[E4930000]           mov       rdi, qword [window.handle]
   155 0000015F E8(00000000)                 call      gtk_widget_show_all
   156                                  
   157 00000164 E8(00000000)                 call      gtk_main
   158                                  Exit:
   159                                       
   160 00000169 4831FF                       xor       rdi, rdi                ; we don't expect much errors now
   161 0000016C E8(00000000)                 call      exit
   162                                  
   163                                  show_about:     
   164                                       ; RDI has GtkWidget *widget
   165                                       ; RSI has gpointer data
   166                                       ; create stackframe to prevent segmentation faults
   167 00000171 55                           push      rbp
   168 00000172 4889E5                       mov       rbp, rsp
   169 00000175 E8(00000000)                 call      gdk_pixbuf_loader_new
   170 0000017A 48890425[97940000]           mov       qword [loader], rax
   171 00000182 488B3C25[97940000]           mov       rdi, qword[loader]
   172 0000018A 48BE-                        mov       rsi, picture
   172 0000018C [C318000000000000] 
   173 00000194 BA217B0000                   mov       edx, picture.size
   174 00000199 4831C9                       xor       rcx, rcx
   175 0000019C E8(00000000)                 call      gdk_pixbuf_loader_write
   176                                  
   177 000001A1 488B3C25[97940000]           mov       rdi, qword[loader]
   178 000001A9 E8(00000000)                 call      gdk_pixbuf_loader_get_pixbuf
   179 000001AE 48890425[A7940000]           mov       qword[pixbuffer.image], rax
   180                                  
   181                                  ;     call      gtk_about_dialog_new
   182                                  ;     mov       qword[dialog.handle], rax
   183                                  
   184 000001B6 488B3C25[19940000]           mov       rdi, qword[dialog]
   185 000001BE 48BE-                        mov       rsi, dialog.title
   185 000001C0 [2194000000000000] 
   186 000001C8 E8(00000000)                 call      gtk_about_dialog_set_program_name
   187                                  
   188 000001CD 488B3C25[19940000]           mov       rdi, qword[dialog]
   189 000001D5 48BE-                        mov       rsi, dialog.version
   189 000001D7 [3494000000000000] 
   190 000001DF E8(00000000)                 call      gtk_about_dialog_set_version
   191                                  
   192 000001E4 488B3C25[19940000]           mov       rdi, qword[dialog]
   193 000001EC 48BE-                        mov       rsi, dialog.copyright
   193 000001EE [3F94000000000000] 
   194 000001F6 E8(00000000)                 call      gtk_about_dialog_set_copyright
   195                                  
   196 000001FB 488B3C25[19940000]           mov       rdi, qword[dialog]
   197 00000203 48BE-                        mov       rsi, dialog.comments
   197 00000205 [5194000000000000] 
   198 0000020D E8(00000000)                 call      gtk_about_dialog_set_comments
   199                                  
   200 00000212 488B3C25[19940000]           mov       rdi, qword[dialog]
   201 0000021A 48BE-                        mov       rsi, dialog.website
   201 0000021C [8194000000000000] 
   202 00000224 E8(00000000)                 call      gtk_about_dialog_set_website
   203                                  
   204 00000229 488B3C25[19940000]           mov       rdi, qword[dialog]
   205 00000231 488B3425[A7940000]           mov       rsi, qword[pixbuffer.image]
   206 00000239 E8(00000000)                 call      gtk_about_dialog_set_logo
   207                                  
   208 0000023E 488B3C25[19940000]           mov       rdi, qword[dialog]
   209 00000246 488B3425[9F940000]           mov       rsi, qword[pixbuffer.icon]
   210 0000024E E8(00000000)                 call      gtk_window_set_icon
   211                                  
   212 00000253 488B3C25[19940000]           mov       rdi, qword[dialog]
   213 0000025B E8(00000000)                 call      gtk_dialog_run
   214                                  
   215 00000260 488B3C25[19940000]           mov       rdi, qword[dialog]
   216 00000268 E8(00000000)                 call      gtk_widget_hide
   217                                  
   218 0000026D C9                           leave
   219 0000026E C3                           ret
