     1                                  ;
     2                                  ; semrm.c -- removes a semaphore
     3                                  ;
     4                                  ; remember ipcs to check the semaphores, ipcrm to remove semaphores
     5                                  ; open a second terminal and type watch -n 1 ipcs to see how the program creates and removes semaphore.
     6                                  ; run the program semdemo, look the semaphore being created.
     7                                  ; run semrm and watch the semaphore being removed.
     8                                  
     9                                  %include "unistd.inc"
    10                              <1> %ifndef _ASM_UNISTD_INC_
    11                              <1> %define _ASM_UNISTD_INC_      1
    12                              <1> 
    13                              <1> %if __BITS__ == 32
    14                              <1>    %warning "using 32 bits syscalls"
    15                              <1>    %include "unistd32.inc"
    16                              <1> %elif __BITS__ == 64
    17                              <1>    %warning "using 64 bits syscalls"
    18          ******************  <1>  warning: using 64 bits syscalls
    19                              <1>    %include "unistd64.inc"
    20                              <2> %ifndef __NASM_SYSCALL64_INC__
    21                              <2> %define __NASM_SYSCALL64_INC__     1
    22                              <2> 
    23                              <2> ; ---------------------------------
    24                              <2> ; SysCall Macro
    25                              <2> ; ---------------------------------
    26                              <2> 
    27                              <2> ; To work around a Nasm warning this macro is defined
    28                              <2> ; as taking 0-7 args since the opcode syscall is used
    29                              <2> ; on 64-bit linux.
    30                              <2> ; Also, use caution when checking integral values that
    31                              <2> ; can benefit from sign-extension.  For example,
    32                              <2> ; 0xFFFFFFFF can be interpreted as -1 or 4294967295.
    33                              <2> ; The adventurous among you can also add checks for
    34                              <2> ; specific cpu types and inject opcodes based on speed
    35                              <2> ; vs. size considerations.
    36                              <2> 
    37                              <2> %imacro syscall 0-7.nolist
    38                              <2> %if %0 > 0
    39                              <2>   %if %0 > 1
    40                              <2>     %if %0 > 2
    41                              <2>       %if %0 > 3
    42                              <2>         %if %0 > 4
    43                              <2>           %if %0 > 5
    44                              <2>             %if %0 > 6
    45                              <2>               %ifnum %{7}
    46                              <2>                 %if %{7} == 0
    47                              <2>                   xor r9, r9
    48                              <2>                 %elif %{7} == -1
    49                              <2>                   or  r9, -1
    50                              <2>                 %elif ((%{7} >= -2147483648) && (%{7} <= 2147483647))
    51                              <2>                   mov r9d, %{7}
    52                              <2>                 %else
    53                              <2>                   mov r9, %{7}
    54                              <2>                 %endif
    55                              <2>               %elifnidni %{7}, r9
    56                              <2>                 mov r9, %{7}
    57                              <2>               %endif
    58                              <2>             %endif
    59                              <2>             %ifnum %{6}
    60                              <2>               %if %{6} == 0
    61                              <2>                 xor r8, r8
    62                              <2>               %elif %{6} == -1
    63                              <2>                 or  r8, -1
    64                              <2>               %elif ((%{6} >= -2147483648) && (%{6} <= 2147483647))
    65                              <2>                 mov r8d, %{6}
    66                              <2>               %else
    67                              <2>                 mov r8, %{6}
    68                              <2>               %endif
    69                              <2>             %elifnidni %{6}, r8
    70                              <2>               mov r8, %{6}
    71                              <2>             %endif
    72                              <2>           %endif
    73                              <2>           %ifnum %{5}
    74                              <2>             %if %{5} == 0
    75                              <2>               xor r10, r10
    76                              <2>             %elif %{5} == -1
    77                              <2>               or  r10, -1
    78                              <2>             %elif ((%{5} >= -2147483648) && (%{5} <= 2147483647))
    79                              <2>               mov r10d, %{5}
    80                              <2>             %else
    81                              <2>               mov r10, %{5}
    82                              <2>             %endif
    83                              <2>           %elifnidni %{5}, r10
    84                              <2>             mov r10, %{5}
    85                              <2>           %endif
    86                              <2>         %endif
    87                              <2>         %ifnum %{4}
    88                              <2>           %if %{4} == 0
    89                              <2>             xor rdx, rdx
    90                              <2>           %elif %{4} == -1
    91                              <2>             or  rdx, -1
    92                              <2>           %elif ((%{4} >= -2147483648) && (%{4} <= 2147483647))
    93                              <2>             mov edx, %{4}
    94                              <2>           %else
    95                              <2>             mov rdx, %{4}
    96                              <2>           %endif
    97                              <2>         %elifnidni %{4}, rdx
    98                              <2>           mov rdx, %{4}
    99                              <2>         %endif
   100                              <2>       %endif
   101                              <2>       %ifnum %{3}
   102                              <2>         %if %{3} == 0
   103                              <2>           xor rsi, rsi
   104                              <2>         %elif %{3} == -1
   105                              <2>           or  rsi, -1
   106                              <2>         %elif ((%{3} >= -2147483648) && (%{3} <= 2147483647))
   107                              <2>           mov esi, %{3}
   108                              <2>         %else
   109                              <2>           mov rsi, %{3}
   110                              <2>         %endif
   111                              <2>       %elifnidni %{3}, rsi
   112                              <2>         mov rsi, %{3}
   113                              <2>       %endif
   114                              <2>     %endif
   115                              <2>     %ifnum %{2}
   116                              <2>       %if %{2} == 0
   117                              <2>         xor rdi, rdi
   118                              <2>       %elif %{2} == -1
   119                              <2>         or  rdi, -1
   120                              <2>       %elif ((%{2} >= -2147483648) && (%{2} <= 2147483647))
   121                              <2>         mov edi, %{2}
   122                              <2>       %else
   123                              <2>         mov rdi, %{2}
   124                              <2>       %endif
   125                              <2>     %elifnidni %{2}, rdi
   126                              <2>       mov rdi, %{2}
   127                              <2>     %endif
   128                              <2>   %endif
   129                              <2>   ; take advantage of sign-extension
   130                              <2>   mov eax, SYS_ %+ %{1}
   131                              <2>   syscall  ; the opcode, not the macro
   132                              <2> %else
   133                              <2>   syscall  ; again, the opcode, not the macro
   134                              <2> %endif  
   135                              <2> %endmacro
   136                              <2> 
   137                              <2> ; ---------------------------------
   138                              <2> ; System Call Listing
   139                              <2> ; ---------------------------------
   140                              <2> 
   141                              <2> %define SYS_read               0
   142                              <2> %define SYS_write              1
   143                              <2> %define SYS_open               2
   144                              <2> %define SYS_close              3
   145                              <2> %define SYS_stat               4
   146                              <2> %define SYS_fstat              5
   147                              <2> %define SYS_lstat              6
   148                              <2> %define SYS_poll               7
   149                              <2> %define SYS_lseek              8
   150                              <2> %define SYS_mmap               9
   151                              <2> %define SYS_mprotect           10
   152                              <2> %define SYS_munmap             11
   153                              <2> %define SYS_brk                12
   154                              <2> %define SYS_rt_sigaction       13
   155                              <2> %define SYS_rt_sigprocmask     14
   156                              <2> %define SYS_rt_sigreturn       15
   157                              <2> %define SYS_ioctl              16
   158                              <2> %define SYS_pread64            17
   159                              <2> %define SYS_pwrite64           18
   160                              <2> %define SYS_readv              19
   161                              <2> %define SYS_writev             20
   162                              <2> %define SYS_access             21
   163                              <2> %define SYS_pipe               22
   164                              <2> %define SYS_select             23
   165                              <2> %define SYS_sched_yield        24
   166                              <2> %define SYS_mremap             25
   167                              <2> %define SYS_msync              26
   168                              <2> %define SYS_mincore            27
   169                              <2> %define SYS_madvise            28
   170                              <2> %define SYS_shmget             29
   171                              <2> %define SYS_shmat              30
   172                              <2> %define SYS_shmctl             31
   173                              <2> %define SYS_dup                32
   174                              <2> %define SYS_dup2               33
   175                              <2> %define SYS_pause              34
   176                              <2> %define SYS_nanosleep          35
   177                              <2> %define SYS_getitimer          36
   178                              <2> %define SYS_alarm              37
   179                              <2> %define SYS_setitimer          38
   180                              <2> %define SYS_getpid             39
   181                              <2> %define SYS_sendfile           40
   182                              <2> %define SYS_socket             41
   183                              <2> %define SYS_connect            42
   184                              <2> %define SYS_accept             43
   185                              <2> %define SYS_sendto             44
   186                              <2> %define SYS_recvfrom           45
   187                              <2> %define SYS_sendmsg            46
   188                              <2> %define SYS_recvmsg            47
   189                              <2> %define SYS_shutdown           48
   190                              <2> %define SYS_bind               49
   191                              <2> %define SYS_listen             50
   192                              <2> %define SYS_getsockname        51
   193                              <2> %define SYS_getpeername        52
   194                              <2> %define SYS_socketpair         53
   195                              <2> %define SYS_setsockopt         54
   196                              <2> %define SYS_getsockopt         55
   197                              <2> %define SYS_clone              56
   198                              <2> %define SYS_fork               57
   199                              <2> %define SYS_vfork              58
   200                              <2> %define SYS_execve             59
   201                              <2> %define SYS_exit               60
   202                              <2> %define SYS_wait4              61
   203                              <2> %define SYS_kill               62
   204                              <2> %define SYS_uname              63
   205                              <2> %define SYS_semget             64
   206                              <2> %define SYS_semop              65
   207                              <2> %define SYS_semctl             66
   208                              <2> %define SYS_shmdt              67
   209                              <2> %define SYS_msgget             68
   210                              <2> %define SYS_msgsnd             69
   211                              <2> %define SYS_msgrcv             70
   212                              <2> %define SYS_msgctl             71
   213                              <2> %define SYS_fcntl              72
   214                              <2> %define SYS_flock              73
   215                              <2> %define SYS_fsync              74
   216                              <2> %define SYS_fdatasync          75
   217                              <2> %define SYS_truncate           76
   218                              <2> %define SYS_ftruncate          77
   219                              <2> %define SYS_getdents           78
   220                              <2> %define SYS_getcwd             79
   221                              <2> %define SYS_chdir              80
   222                              <2> %define SYS_fchdir             81
   223                              <2> %define SYS_rename             82
   224                              <2> %define SYS_mkdir              83
   225                              <2> %define SYS_rmdir              84
   226                              <2> %define SYS_creat              85
   227                              <2> %define SYS_link               86
   228                              <2> %define SYS_unlink             87
   229                              <2> %define SYS_symlink            88
   230                              <2> %define SYS_readlink           89
   231                              <2> %define SYS_chmod              90
   232                              <2> %define SYS_fchmod             91
   233                              <2> %define SYS_chown              92
   234                              <2> %define SYS_fchown             93
   235                              <2> %define SYS_lchown             94
   236                              <2> %define SYS_umask              95
   237                              <2> %define SYS_gettimeofday       96
   238                              <2> %define SYS_getrlimit          97
   239                              <2> %define SYS_getrusage          98
   240                              <2> %define SYS_sysinfo            99
   241                              <2> %define SYS_times              100
   242                              <2> %define SYS_ptrace             101
   243                              <2> %define SYS_getuid             102
   244                              <2> %define SYS_syslog             103
   245                              <2> %define SYS_getgid             104
   246                              <2> %define SYS_setuid             105
   247                              <2> %define SYS_setgid             106
   248                              <2> %define SYS_geteuid            107
   249                              <2> %define SYS_getegid            108
   250                              <2> %define SYS_setpgid            109
   251                              <2> %define SYS_getppid            110
   252                              <2> %define SYS_getpgrp            111
   253                              <2> %define SYS_setsid             112
   254                              <2> %define SYS_setreuid           113
   255                              <2> %define SYS_setregid           114
   256                              <2> %define SYS_getgroups          115
   257                              <2> %define SYS_setgroups          116
   258                              <2> %define SYS_setresuid          117
   259                              <2> %define SYS_getresuid          118
   260                              <2> %define SYS_setresgid          119
   261                              <2> %define SYS_getresgid          120
   262                              <2> %define SYS_getpgid            121
   263                              <2> %define SYS_setfsuid           122
   264                              <2> %define SYS_setfsgid           123
   265                              <2> %define SYS_getsid             124
   266                              <2> %define SYS_capget             125
   267                              <2> %define SYS_capset             126
   268                              <2> %define SYS_rt_sigpending      127
   269                              <2> %define SYS_rt_sigtimedwait    128
   270                              <2> %define SYS_rt_sigqueueinfo    129
   271                              <2> %define SYS_rt_sigsuspend      130
   272                              <2> %define SYS_sigaltstack        131
   273                              <2> %define SYS_utime              132
   274                              <2> %define SYS_mknod              133
   275                              <2> %define SYS_uselib             134
   276                              <2> %define SYS_personality        135
   277                              <2> %define SYS_ustat              136
   278                              <2> %define SYS_statfs             137
   279                              <2> %define SYS_fstatfs            138
   280                              <2> %define SYS_sysfs              139
   281                              <2> %define SYS_getpriority        140
   282                              <2> %define SYS_setpriority        141
   283                              <2> %define SYS_sched_setparam     142
   284                              <2> %define SYS_sched_getparam     143
   285                              <2> %define SYS_sched_setscheduler 144
   286                              <2> %define SYS_sched_getscheduler 145
   287                              <2> %define SYS_sched_get_priority_max 146
   288                              <2> %define SYS_sched_get_priority_min 147
   289                              <2> %define SYS_sched_rr_get_interval  148
   290                              <2> %define SYS_mlock              149
   291                              <2> %define SYS_munlock            150
   292                              <2> %define SYS_mlockall           151
   293                              <2> %define SYS_munlockall         152
   294                              <2> %define SYS_vhangup            153
   295                              <2> %define SYS_modify_ldt         154
   296                              <2> %define SYS_pivot_root         155
   297                              <2> %define SYS__sysctl            156
   298                              <2> %define SYS_prctl              157
   299                              <2> %define SYS_arch_prctl         158
   300                              <2> %define SYS_adjtimex           159
   301                              <2> %define SYS_setrlimit          160
   302                              <2> %define SYS_chroot             161
   303                              <2> %define SYS_sync               162
   304                              <2> %define SYS_acct               163
   305                              <2> %define SYS_settimeofday       164
   306                              <2> %define SYS_mount              165
   307                              <2> %define SYS_umount2            166
   308                              <2> %define SYS_swapon             167
   309                              <2> %define SYS_swapoff            168
   310                              <2> %define SYS_reboot             169
   311                              <2> %define SYS_sethostname        170
   312                              <2> %define SYS_setdomainname      171
   313                              <2> %define SYS_iopl               172
   314                              <2> %define SYS_ioperm             173
   315                              <2> %define SYS_create_module      174
   316                              <2> %define SYS_init_module        175
   317                              <2> %define SYS_delete_module      176
   318                              <2> %define SYS_get_kernel_syms    177
   319                              <2> %define SYS_query_module       178
   320                              <2> %define SYS_quotactl           179
   321                              <2> %define SYS_nfsservctl         180
   322                              <2> %define SYS_getpmsg            181
   323                              <2> %define SYS_putpmsg            182
   324                              <2> %define SYS_afs_syscall        183
   325                              <2> %define SYS_tuxcall            184
   326                              <2> %define SYS_security           185
   327                              <2> %define SYS_gettid             186
   328                              <2> %define SYS_readahead          187
   329                              <2> %define SYS_setxattr           188
   330                              <2> %define SYS_lsetxattr          189
   331                              <2> %define SYS_fsetxattr          190
   332                              <2> %define SYS_getxattr           191
   333                              <2> %define SYS_lgetxattr          192
   334                              <2> %define SYS_fgetxattr          193
   335                              <2> %define SYS_listxattr          194
   336                              <2> %define SYS_llistxattr         195
   337                              <2> %define SYS_flistxattr         196
   338                              <2> %define SYS_removexattr        197
   339                              <2> %define SYS_lremovexattr       198
   340                              <2> %define SYS_fremovexattr       199
   341                              <2> %define SYS_tkill              200
   342                              <2> %define SYS_time               201
   343                              <2> %define SYS_futex              202
   344                              <2> %define SYS_sched_setaffinity  203
   345                              <2> %define SYS_sched_getaffinity  204
   346                              <2> %define SYS_set_thread_area    205
   347                              <2> %define SYS_io_setup           206
   348                              <2> %define SYS_io_destroy         207
   349                              <2> %define SYS_io_getevents       208
   350                              <2> %define SYS_io_submit          209
   351                              <2> %define SYS_io_cancel          210
   352                              <2> %define SYS_get_thread_area    211
   353                              <2> %define SYS_lookup_dcookie     212
   354                              <2> %define SYS_epoll_create       213
   355                              <2> %define SYS_epoll_ctl_old      214
   356                              <2> %define SYS_epoll_wait_old     215
   357                              <2> %define SYS_remap_file_pages   216
   358                              <2> %define SYS_getdents64         217
   359                              <2> %define SYS_set_tid_address    218
   360                              <2> %define SYS_restart_syscall    219
   361                              <2> %define SYS_semtimedop         220
   362                              <2> %define SYS_fadvise64          221
   363                              <2> %define SYS_timer_create       222
   364                              <2> %define SYS_timer_settime      223
   365                              <2> %define SYS_timer_gettime      224
   366                              <2> %define SYS_timer_getoverrun   225
   367                              <2> %define SYS_timer_delete       226
   368                              <2> %define SYS_clock_settime      227
   369                              <2> %define SYS_clock_gettime      228
   370                              <2> %define SYS_clock_getres       229
   371                              <2> %define SYS_clock_nanosleep    230
   372                              <2> %define SYS_exit_group         231
   373                              <2> %define SYS_epoll_wait         232
   374                              <2> %define SYS_epoll_ctl          233
   375                              <2> %define SYS_tgkill             234
   376                              <2> %define SYS_utimes             235
   377                              <2> %define SYS_vserver            236
   378                              <2> %define SYS_mbind              237
   379                              <2> %define SYS_set_mempolicy      238
   380                              <2> %define SYS_get_mempolicy      239
   381                              <2> %define SYS_mq_open            240
   382                              <2> %define SYS_mq_unlink          241
   383                              <2> %define SYS_mq_timedsend       242
   384                              <2> %define SYS_mq_timedreceive    243
   385                              <2> %define SYS_mq_notify          244
   386                              <2> %define SYS_mq_getsetattr      245
   387                              <2> %define SYS_kexec_load         246
   388                              <2> %define SYS_waitid             247
   389                              <2> %define SYS_add_key            248
   390                              <2> %define SYS_request_key        249
   391                              <2> %define SYS_keyctl             250
   392                              <2> %define SYS_ioprio_set         251
   393                              <2> %define SYS_ioprio_get         252
   394                              <2> %define SYS_inotify_init       253
   395                              <2> %define SYS_inotify_add_watch  254
   396                              <2> %define SYS_inotify_rm_watch   255
   397                              <2> %define SYS_migrate_pages      256
   398                              <2> %define SYS_openat             257
   399                              <2> %define SYS_mkdirat            258
   400                              <2> %define SYS_mknodat            259
   401                              <2> %define SYS_fchownat           260
   402                              <2> %define SYS_futimesat          261
   403                              <2> %define SYS_newfstatat         262
   404                              <2> %define SYS_unlinkat           263
   405                              <2> %define SYS_renameat           264
   406                              <2> %define SYS_linkat             265
   407                              <2> %define SYS_symlinkat          266
   408                              <2> %define SYS_readlinkat         267
   409                              <2> %define SYS_fchmodat           268
   410                              <2> %define SYS_faccessat          269
   411                              <2> %define SYS_pselect6           270
   412                              <2> %define SYS_ppoll              271
   413                              <2> %define SYS_unshare            272
   414                              <2> %define SYS_set_robust_list    273
   415                              <2> %define SYS_get_robust_list    274
   416                              <2> %define SYS_splice             275
   417                              <2> %define SYS_tee                276
   418                              <2> %define SYS_sync_file_range    277
   419                              <2> %define SYS_vmsplice           278
   420                              <2> %define SYS_move_pages         279
   421                              <2> %define SYS_utimensat          280
   422                              <2> %define SYS_epoll_pwait        281
   423                              <2> %define SYS_signalfd           282
   424                              <2> %define SYS_timerfd_create     283
   425                              <2> %define SYS_eventfd            284
   426                              <2> %define SYS_fallocate          285
   427                              <2> %define SYS_timerfd_settime    286
   428                              <2> %define SYS_timerfd_gettime    287
   429                              <2> %define SYS_accept4            288
   430                              <2> %define SYS_signalfd4          289
   431                              <2> %define SYS_eventfd2           290
   432                              <2> %define SYS_epoll_create1      291
   433                              <2> %define SYS_dup3               292
   434                              <2> %define SYS_pipe2              293
   435                              <2> %define SYS_inotify_init1      294
   436                              <2> %define SYS_preadv             295
   437                              <2> %define SYS_pwritev            296
   438                              <2> %define SYS_rt_tgsigqueueinfo  297
   439                              <2> %define SYS_perf_event_open    298
   440                              <2> %define SYS_recvmmsg           299
   441                              <2> 
   442                              <2> %endif
   443                              <1>    %include "obsolete_syscalls.inc"          ; this file will be removed once all examples are updated
   444                              <2> %ifndef _ASM_OBSOLETE_SYSCALLS_INC_
   445                              <2> %define _ASM_OBSOLETE_SYSCALLS_INC_     1
   446                              <2>  
   447                              <2>   %define SYS_ACCEPT                 43
   448                              <2>   %define SYS_ACCEPT4                288
   449                              <2>   %define SYS_ACCESS                 21
   450                              <2>   %define SYS_ACCT                   163
   451                              <2>   %define SYS_ADD_KEY                248
   452                              <2>   %define SYS_ADJTIMEX               159
   453                              <2>   %define SYS_AFS_SYSCALL            183
   454                              <2>   %define SYS_ALARM                  37
   455                              <2>   %define SYS_ARCH_PRCTL             158
   456                              <2>   %define SYS_BIND                   49
   457                              <2>   %define SYS_BRK                    12
   458                              <2>   %define SYS_CAPGET                 125
   459                              <2>   %define SYS_CAPSET                 126
   460                              <2>   %define SYS_CHDIR                  80 
   461                              <2>   %define SYS_CHMOD                  90 
   462                              <2>   %define SYS_CHOWN                  92 
   463                              <2>   %define SYS_CHROOT                 161
   464                              <2>   %define SYS_CLOCK_GETRES           229
   465                              <2>   %define SYS_CLOCK_GETTIME          228
   466                              <2>   %define SYS_CLOCK_NANOSLEEP        230
   467                              <2>   %define SYS_CLOCK_SETTIME          227
   468                              <2>   %define SYS_CLONE                  56
   469                              <2>   %define SYS_CLOSE                  3
   470                              <2>   %define SYS_CONNECT                42
   471                              <2>   %define SYS_CREAT                  85
   472                              <2>   %define SYS_CREATE_MODULE          174
   473                              <2>   %define SYS_DELETE_MODULE          176
   474                              <2>   %define SYS_DUP                    32
   475                              <2>   %define SYS_DUP2                   33
   476                              <2>   %define SYS_DUP3                   292
   477                              <2>   %define SYS_EPOLL_CREATE           213
   478                              <2>   %define SYS_EPOLL_CREATE1          291
   479                              <2>   %define SYS_EPOLL_CTL              233
   480                              <2>   %define SYS_EPOLL_CTL_OLD          214
   481                              <2>   %define SYS_EPOLL_PWAIT            281
   482                              <2>   %define SYS_EPOLL_WAIT             232
   483                              <2>   %define SYS_EPOLL_WAIT_OLD         215
   484                              <2>   %define SYS_EVENTFD                284
   485                              <2>   %define SYS_EVENTFD2               290
   486                              <2>   %define SYS_EXECVE                 59
   487                              <2>   %define SYS_EXIT                   60
   488                              <2>   %define SYS_EXIT_GROUP             231
   489                              <2>   %define SYS_FACCESSAT              269
   490                              <2>   %define SYS_FADVISE64              221
   491                              <2>   %define SYS_FALLOCATE              285
   492                              <2>   %define SYS_FANOTIFY_INIT          300
   493                              <2>   %define SYS_FANOTIFY_MARK          301
   494                              <2>   %define SYS_FCHDIR                 81
   495                              <2>   %define SYS_FCHMOD                 91
   496                              <2>   %define SYS_FCHMODAT               268
   497                              <2>   %define SYS_FCHOWN                 93 
   498                              <2>   %define SYS_FCHOWNAT               260
   499                              <2>   %define SYS_FCNTL                  72 
   500                              <2>   %define SYS_FDATASYNC              75 
   501                              <2>   %define SYS_FGETXATTR              193
   502                              <2>   %define SYS_FLISTXATTR             196
   503                              <2>   %define SYS_FLOCK                  73 
   504                              <2>   %define SYS_FORK                   57 
   505                              <2>   %define SYS_FREMOVEXATTR           199
   506                              <2>   %define SYS_FSETXATTR              190
   507                              <2>   %define SYS_FSTAT                  5  
   508                              <2>   %define SYS_FSTATFS                138
   509                              <2>   %define SYS_FSYNC                  74 
   510                              <2>   %define SYS_FTRUNCATE              77 
   511                              <2>   %define SYS_FUTEX                  202
   512                              <2>   %define SYS_FUTIMESAT              261
   513                              <2>   %define SYS_GET_KERNEL_SYMS        177
   514                              <2>   %define SYS_GET_MEMPOLICY          239
   515                              <2>   %define SYS_GET_ROBUST_LIST        274
   516                              <2>   %define SYS_GET_THREAD_AREA        211
   517                              <2>   %define SYS_GETCWD                 79 
   518                              <2>   %define SYS_GETDENTS               78 
   519                              <2>   %define SYS_GETDENTS64             217
   520                              <2>   %define SYS_GETEGID                108
   521                              <2>   %define SYS_GETEUID                107
   522                              <2>   %define SYS_GETGID                 104
   523                              <2>   %define SYS_GETGROUPS              115
   524                              <2>   %define SYS_GETITIMER              36 
   525                              <2>   %define SYS_GETPEERNAME            52 
   526                              <2>   %define SYS_GETPGID                121
   527                              <2>   %define SYS_GETPGRP                111
   528                              <2>   %define SYS_GETPID                 39 
   529                              <2>   %define SYS_GETPMSG                181
   530                              <2>   %define SYS_GETPPID                110
   531                              <2>   %define SYS_GETPRIORITY            140
   532                              <2>   %define SYS_GETRESGID              120
   533                              <2>   %define SYS_GETRESUID              118
   534                              <2>   %define SYS_GETRLIMIT              97 
   535                              <2>   %define SYS_GETRUSAGE              98 
   536                              <2>   %define SYS_GETSID                 124
   537                              <2>   %define SYS_GETSOCKNAME            51 
   538                              <2>   %define SYS_GETSOCKOPT             55 
   539                              <2>   %define SYS_GETTID                 186
   540                              <2>   %define SYS_GETTIMEOFDAY           96 
   541                              <2>   %define SYS_GETUID                 102
   542                              <2>   %define SYS_GETXATTR               191
   543                              <2>   %define SYS_INIT_MODULE            175
   544                              <2>   %define SYS_INOTIFY_ADD_WATCH      254
   545                              <2>   %define SYS_INOTIFY_INIT           253
   546                              <2>   %define SYS_INOTIFY_INIT1          294
   547                              <2>   %define SYS_INOTIFY_RM_WATCH       255
   548                              <2>   %define SYS_IO_CANCEL              210
   549                              <2>   %define SYS_IO_DESTROY             207
   550                              <2>   %define SYS_IO_GETEVENTS           208
   551                              <2>   %define SYS_IO_SETUP               206
   552                              <2>   %define SYS_IO_SUBMIT              209
   553                              <2>   %define SYS_IOCTL                  16 
   554                              <2>   %define SYS_IOPERM                 173
   555                              <2>   %define SYS_IOPL                   172
   556                              <2>   %define SYS_IOPRIO_GET             252
   557                              <2>   %define SYS_IOPRIO_SET             251
   558                              <2>   %define SYS_KEXEC_LOAD             246
   559                              <2>   %define SYS_KEYCTL                 250
   560                              <2>   %define SYS_KILL                   62
   561                              <2>   %define SYS_LCHOWN                 94 
   562                              <2>   %define SYS_LGETXATTR              192
   563                              <2>   %define SYS_LINK                   86 
   564                              <2>   %define SYS_LINKAT                 265
   565                              <2>   %define SYS_LISTEN                 50 
   566                              <2>   %define SYS_LISTXATTR              194
   567                              <2>   %define SYS_LLISTXATTR             195
   568                              <2>   %define SYS_LOOKUP_DCOOKIE         212
   569                              <2>   %define SYS_LREMOVEXATTR           198
   570                              <2>   %define SYS_LSEEK                  8  
   571                              <2>   %define SYS_LSETXATTR              189
   572                              <2>   %define SYS_LSTAT                  6
   573                              <2>   %define SYS_MADVISE                28 
   574                              <2>   %define SYS_MBIND                  237
   575                              <2>   %define SYS_MIGRATE_PAGES          256
   576                              <2>   %define SYS_MINCORE                27 
   577                              <2>   %define SYS_MKDIR                  83 
   578                              <2>   %define SYS_MKDIRAT                258
   579                              <2>   %define SYS_MKNOD                  133
   580                              <2>   %define SYS_MKNODAT                259
   581                              <2>   %define SYS_MLOCK                  149
   582                              <2>   %define SYS_MLOCKALL               151
   583                              <2>   %define SYS_MMAP                   9  
   584                              <2>   %define SYS_MODIFY_LDT             154
   585                              <2>   %define SYS_MOUNT                  165
   586                              <2>   %define SYS_MOVE_PAGES             279
   587                              <2>   %define SYS_MPROTECT               10 
   588                              <2>   %define SYS_MQ_GETSETATTR          245
   589                              <2>   %define SYS_MQ_NOTIFY              244
   590                              <2>   %define SYS_MQ_OPEN                240
   591                              <2>   %define SYS_MQ_TIMEDRECEIVE        243
   592                              <2>   %define SYS_MQ_TIMEDSEND           242
   593                              <2>   %define SYS_MQ_UNLINK              241
   594                              <2>   %define SYS_MREMAP                 25 
   595                              <2>   %define SYS_MSGCTL                 71 
   596                              <2>   %define SYS_MSGGET                 68
   597                              <2>   %define SYS_MSGRCV                 70
   598                              <2>   %define SYS_MSGSND                 69
   599                              <2>   %define SYS_MSYNC                  26
   600                              <2>   %define SYS_MUNLOCK                150
   601                              <2>   %define SYS_MUNLOCKALL             152
   602                              <2>   %define SYS_MUNMAP                 11 
   603                              <2>   %define SYS_NANOSLEEP              35
   604                              <2>   %define SYS_NEWFSTATAT             262
   605                              <2>   %define SYS_NFSSERVCTL             180
   606                              <2>   %define SYS_OPEN                   2
   607                              <2>   %define SYS_OPENAT                 257
   608                              <2>   %define SYS_PAUSE                  34 
   609                              <2>   %define SYS_PERF_EVENT_OPEN        298
   610                              <2>   %define SYS_PERSONALITY            135
   611                              <2>   %define SYS_PIPE                   22 
   612                              <2>   %define SYS_PIPE2                  293
   613                              <2>   %define SYS_PIVOT_ROOT             155
   614                              <2>   %define SYS_POLL                   7  
   615                              <2>   %define SYS_PPOLL                  271
   616                              <2>   %define SYS_PRCTL                  157
   617                              <2>   %define SYS_PREAD64                17 
   618                              <2>   %define SYS_PREADV                 295
   619                              <2>   %define SYS_PRLIMIT64              302
   620                              <2>   %define SYS_PSELECT6               270
   621                              <2>   %define SYS_PTRACE                 101
   622                              <2>   %define SYS_PUTPMSG                182
   623                              <2>   %define SYS_PWRITE64               18 
   624                              <2>   %define SYS_PWRITEV                296
   625                              <2>   %define SYS_QUERY_MODULE           178
   626                              <2>   %define SYS_QUOTACTL               179
   627                              <2>   %define SYS_READ                   0  
   628                              <2>   %define SYS_READAHEAD              187
   629                              <2>   %define SYS_READLINK               89 
   630                              <2>   %define SYS_READLINKAT             267
   631                              <2>   %define SYS_READV                  19 
   632                              <2>   %define SYS_REBOOT                 169
   633                              <2>   %define SYS_RECVFROM               45 
   634                              <2>   %define SYS_RECVMMSG               299
   635                              <2>   %define SYS_RECVMSG                47 
   636                              <2>   %define SYS_REMAP_FILE_PAGES       216
   637                              <2>   %define SYS_REMOVEXATTR            197
   638                              <2>   %define SYS_RENAME                 82 
   639                              <2>   %define SYS_RENAMEAT               264
   640                              <2>   %define SYS_REQUEST_KEY            249
   641                              <2>   %define SYS_RESTART_SYSCALL        219
   642                              <2>   %define SYS_RMDIR                  84 
   643                              <2>   %define SYS_RT_SIGACTION           13
   644                              <2>   %define SYS_RT_SIGPENDING          127
   645                              <2>   %define SYS_RT_SIGPROCMASK         14 
   646                              <2>   %define SYS_RT_SIGQUEUEINFO        129
   647                              <2>   %define SYS_RT_SIGRETURN           15 
   648                              <2>   %define SYS_RT_SIGSUSPEND          130
   649                              <2>   %define SYS_RT_SIGTIMEDWAIT        128
   650                              <2>   %define SYS_RT_TGSIGQUEUEINFO      297
   651                              <2>   %define SYS_SCHED_GET_PRIORITY_MAX 146
   652                              <2>   %define SYS_SCHED_GET_PRIORITY_MIN 147
   653                              <2>   %define SYS_SCHED_GETAFFINITY      204
   654                              <2>   %define SYS_SCHED_GETPARAM         143
   655                              <2>   %define SYS_SCHED_GETSCHEDULER     145
   656                              <2>   %define SYS_SCHED_RR_GET_INTERVAL  148
   657                              <2>   %define SYS_SCHED_SETAFFINITY      203
   658                              <2>   %define SYS_SCHED_SETPARAM         142
   659                              <2>   %define SYS_SCHED_SETSCHEDULER     144
   660                              <2>   %define SYS_SCHED_YIELD            24 
   661                              <2>   %define SYS_SECURITY               185
   662                              <2>   %define SYS_SELECT                 23 
   663                              <2>   %define SYS_SEMCTL                 66 
   664                              <2>   %define SYS_SEMGET                 64 
   665                              <2>   %define SYS_SEMOP                  65 
   666                              <2>   %define SYS_SEMTIMEDOP             220
   667                              <2>   %define SYS_SENDFILE               40 
   668                              <2>   %define SYS_SENDMSG                46 
   669                              <2>   %define SYS_SENDTO                 44 
   670                              <2>   %define SYS_SET_MEMPOLICY          238
   671                              <2>   %define SYS_SET_ROBUST_LIST        273
   672                              <2>   %define SYS_SET_THREAD_AREA        205
   673                              <2>   %define SYS_SET_TID_ADDRESS        218
   674                              <2>   %define SYS_SETDOMAINNAME          171
   675                              <2>   %define SYS_SETFSGID               123
   676                              <2>   %define SYS_SETFSUID               122
   677                              <2>   %define SYS_SETGID                 106
   678                              <2>   %define SYS_SETGROUPS              116
   679                              <2>   %define SYS_SETHOSTNAME            170
   680                              <2>   %define SYS_SETITIMER              38 
   681                              <2>   %define SYS_SETPGID                109
   682                              <2>   %define SYS_SETPRIORITY            141
   683                              <2>   %define SYS_SETREGID               114
   684                              <2>   %define SYS_SETRESGID              119
   685                              <2>   %define SYS_SETRESUID              117
   686                              <2>   %define SYS_SETREUID               113
   687                              <2>   %define SYS_SETRLIMIT              160
   688                              <2>   %define SYS_SETSID                 112
   689                              <2>   %define SYS_SETSOCKOPT             54 
   690                              <2>   %define SYS_SETTIMEOFDAY           164
   691                              <2>   %define SYS_SETUID                 105
   692                              <2>   %define SYS_SETXATTR               188
   693                              <2>   %define SYS_SHMAT                  30 
   694                              <2>   %define SYS_SHMCTL                 31 
   695                              <2>   %define SYS_SHMDT                  67 
   696                              <2>   %define SYS_SHMGET                 29 
   697                              <2>   %define SYS_SHUTDOWN               48 
   698                              <2>   %define SYS_SIGALTSTACK            131
   699                              <2>   %define SYS_SIGNALFD               282
   700                              <2>   %define SYS_SIGNALFD4              289
   701                              <2>   %define SYS_SOCKET                 41 
   702                              <2>   %define SYS_SOCKETPAIR             53 
   703                              <2>   %define SYS_SPLICE                 275
   704                              <2>   %define SYS_STAT                   4  
   705                              <2>   %define SYS_STATFS                 137
   706                              <2>   %define SYS_SWAPOFF                168
   707                              <2>   %define SYS_SWAPON                 167
   708                              <2>   %define SYS_SYMLINK                88 
   709                              <2>   %define SYS_SYMLINKAT              266
   710                              <2>   %define SYS_SYNC                   162
   711                              <2>   %define SYS_SYNC_FILE_RANGE        277
   712                              <2>   %define SYS__SYSCTL                156
   713                              <2>   %define SYS_SYSFS                  139
   714                              <2>   %define SYS_SYSINFO                99 
   715                              <2>   %define SYS_SYSLOG                 103
   716                              <2>   %define SYS_TEE                    276
   717                              <2>   %define SYS_TGKILL                 234
   718                              <2>   %define SYS_TIME                   201
   719                              <2>   %define SYS_TIMER_CREATE           222
   720                              <2>   %define SYS_TIMER_DELETE           226
   721                              <2>   %define SYS_TIMER_GETOVERRUN       225
   722                              <2>   %define SYS_TIMER_GETTIME          224
   723                              <2>   %define SYS_TIMER_SETTIME          223
   724                              <2>   %define SYS_TIMERFD_CREATE         283
   725                              <2>   %define SYS_TIMERFD_GETTIME        287
   726                              <2>   %define SYS_TIMERFD_SETTIME        286
   727                              <2>   %define SYS_TIMES                  100
   728                              <2>   %define SYS_TKILL                  200
   729                              <2>   %define SYS_TRUNCATE               76 
   730                              <2>   %define SYS_TUXCALL                184
   731                              <2>   %define SYS_UMASK                  95 
   732                              <2>   %define SYS_UMOUNT2                166
   733                              <2>   %define SYS_UNAME                  63 
   734                              <2>   %define SYS_UNLINK                 87 
   735                              <2>   %define SYS_UNLINKAT               263
   736                              <2>   %define SYS_UNSHARE                272
   737                              <2>   %define SYS_USELIB                 134
   738                              <2>   %define SYS_USTAT                  136
   739                              <2>   %define SYS_UTIME                  132
   740                              <2>   %define SYS_UTIMENSAT              280
   741                              <2>   %define SYS_UTIMES                 235
   742                              <2>   %define SYS_VFORK                  58 
   743                              <2>   %define SYS_VHANGUP                153
   744                              <2>   %define SYS_VMSPLICE               278
   745                              <2>   %define SYS_VSERVER                236
   746                              <2>   %define SYS_WAIT4                  61
   747                              <2>   %define SYS_WAITID                 247
   748                              <2>   %define SYS_WRITE                  1
   749                              <2>   %define SYS_WRITEV                 20
   750                              <2> %endif  
   751                              <1> %endif
   752                              <1>      %define stdin   0
   753                              <1>      %define stdout  1
   754                              <1>      %define stderr  2
   755                              <1>      %define STDIN   0             ; just in case someone likes the uppercase version
   756                              <1>      %define STDOUT  1             ; just in case someone likes the uppercase version
   757                              <1>      %define STDERR  2             ; just in case someone likes the uppercase version
   758                              <1>      %define true    1
   759                              <1>      %define false   0
   760                              <1>      %define TRUE    1
   761                              <1>      %define FALSE   0
   762                              <1> %endif
   763                                  %include "sys/stat.inc"
   764                              <1> %ifndef _ASM_STAT_INC_
   765                              <1> %define _ASM_STAT_INC_   1
   766                              <1>      
   767                              <1>      ; THIS FILE COULD CONTAIN ERRORS IN THE STRUCTURES
   768                              <1>      ; USE AT YOUR OWN RISK
   769                              <1>      ; stat structure is already tested and should work fine
   770                              <1>      
   771                              <1>      ; permission en type flags
   772                              <1>      
   773                              <1>      %define   O_RDONLY                0
   774                              <1>      %define   O_WRONLY                1
   775                              <1>      %define   O_RDWR                  2
   776                              <1>      %define   O_ACCMODE               3
   777                              <1>      %define   O_CREAT                64
   778                              <1>      %define   O_EXCL                128
   779                              <1>      %define   O_NOCTTY              256
   780                              <1>      %define   O_TRUNC               512
   781                              <1>      %define   O_APPEND             1024
   782                              <1> 
   783                              <1>      %define   O_DIRECTORY         65536 
   784                              <1>      %define   O_NONBLOCK           2048
   785                              <1>      %define   O_NDELAY       O_NONBLOCK
   786                              <1> 
   787                              <1>      ; File types.
   788                              <1> 
   789                              <1>      %define   S_IFMT         61440     ; bit mask for the file type bit fields
   790                              <1>      %define   S_IFSOCK       49152     ; socket
   791                              <1>      %define   S_IFLNK        40960     ; symbolic link
   792                              <1>      %define   S_IFREG        32768     ; regular file
   793                              <1>      %define   S_IFBLK        24576     ; block device
   794                              <1>      %define   S_IFDIR        16384     ; directory
   795                              <1>      %define   S_IFCHR         8192     ; character device
   796                              <1>      %define   S_IFIFO         4096     ; FIFO
   797                              <1>      %define   S_ISUID         2048     ; set UID bit
   798                              <1>      %define   S_ISGID         1024     ; set-group-ID bit (see below)
   799                              <1>      %define   S_ISVTX          512     ; sticky bit (see below)
   800                              <1>     
   801                              <1>      ; Protection bits.
   802                              <1> 
   803                              <1>      %define   S_ISUID        04000                         ; Set user ID on execution.
   804                              <1>      %define   S_ISGID        02000                         ; Set group ID on execution.
   805                              <1>      %define   S_ISVTX        01000                         ; Save swapped text after use (sticky).
   806                              <1>      %define   S_IREAD         0400                         ; Read by owner.
   807                              <1>      %define   S_IWRITE        0200                         ; Write by owner.
   808                              <1>      %define   S_IEXEC         0100                         ; Execute by owner.
   809                              <1>      
   810                              <1>      %define   S_IRUSR        S_IREAD                       ; Read by owner.
   811                              <1>      %define   S_IWUSR        S_IWRITE                      ; Write by owner.
   812                              <1>      %define   S_IXUSR        S_IEXEC                       ; Execute by owner.
   813                              <1>      %define   S_IRWXU        (S_IREAD|S_IWRITE|S_IEXEC)    ; Read, write, and execute by owner.
   814                              <1>  
   815                              <1>      %define   S_IRGRP        (S_IRUSR >> 3)                ; Read by group.
   816                              <1>      %define   S_IWGRP        (S_IWUSR >> 3)                ; Write by group.
   817                              <1>      %define   S_IXGRP        (S_IXUSR >> 3)                ; Execute by group.
   818                              <1>      %define   S_IRWXG        (S_IRWXU >> 3)                ; Read, write, and execute by group.
   819                              <1> 
   820                              <1>      %define   S_IROTH        (S_IRGRP >> 3)                ; Read by others.
   821                              <1>      %define   S_IWOTH        (S_IWGRP >> 3)                ; Write by others.
   822                              <1>      %define   S_IXOTH        (S_IXGRP >> 3)                ; Execute by others.
   823                              <1>      %define   S_IRWXO        (S_IRWXG >> 3)                ; Read, write, and execute by others.
   824                              <1>      
   825                              <1>      ; STAT structure definition
   826                              <1>      STRUC STAT_STRUC
   827 00000000 <res 00000008>      <1>           .st_dev:          resq 1    ; device
   828 00000008 <res 00000008>      <1>           .st_ino:          resq 1    ; file serial number
   829 00000010 <res 00000008>      <1>           .st_nlink:        resq 1    ; link count 
   830 00000018 <res 00000004>      <1>           .st_mod:          resd 1    ; file mode
   831 0000001C <res 00000004>      <1>           .st_uid:          resd 1    ; user id of owner
   832 00000020 <res 00000004>      <1>           .st_gid:          resd 1    ; group id of owner
   833 00000024 <res 00000008>      <1>           .st_rdev:         resq 1    ; device number if device
   834 0000002C <res 00000004>      <1>           ._pad1:           resd 1
   835 00000030 <res 00000008>      <1>           .st_size:         resq 1    ; filesize in bytes
   836 00000038 <res 00000004>      <1>           .st_blksize:      resd 1    ; optimal block size for I/O
   837 0000003C <res 00000004>      <1>           ._pad2:           resd 1
   838 00000040 <res 00000008>      <1>           .st_blocks:       resq 1    ; number of 512-byte blocks allocated
   839 00000048 <res 00000008>      <1>           .st_atime:        resq 1    ; last access time secs
   840 00000050 <res 00000008>      <1>           .st_atime_nsec:   resq 1    ; last access time nsecs
   841 00000058 <res 00000008>      <1>           .st_mtime:        resq 1    ; last modification time secs
   842 00000060 <res 00000008>      <1>           .st_mtime_nsec:   resq 1    ; last modification time nsecs
   843 00000068 <res 00000008>      <1>           .st_ctime:        resq 1    ; last status changed time secs
   844 00000070 <res 00000008>      <1>           .st_ctime_nsec:   resq 1    ; last status changed time nsecs
   845 00000078 <res 00000008>      <1>           ._unused1:        resq 1
   846 00000080 <res 00000008>      <1>           ._unused2:        resq 1
   847 00000088 <res 00000008>      <1>           ._unused3:        resq 1
   848                              <1>      ENDSTRUC
   849                              <1> 
   850                              <1>      %macro STAT 1
   851                              <1>           %1: 
   852                              <1>           ISTRUC STAT_STRUC
   853                              <1>                at STAT_STRUC.st_dev,        dq 0 ; device
   854                              <1>                at STAT_STRUC.st_ino,        dq 0 ; file serial number
   855                              <1>                at STAT_STRUC.st_nlink,      dq 0 ; link count 
   856                              <1>                at STAT_STRUC.st_mod,        dd 0 ; file mode
   857                              <1>                at STAT_STRUC.st_uid,        dd 0 ; user id of owner
   858                              <1>                at STAT_STRUC.st_gid,        dd 0 ; group id of owner
   859                              <1>                at STAT_STRUC.st_rdev,       dq 0 ; device number if device
   860                              <1>                at STAT_STRUC._pad1,         dd 0
   861                              <1>                at STAT_STRUC.st_size,       dq 0 ; filesize in bytes
   862                              <1>                at STAT_STRUC.st_blksize,    dd 0 ; optimal block size for I/O
   863                              <1>                at STAT_STRUC._pad2,         dd 0
   864                              <1>                at STAT_STRUC.st_blocks,     dq 0 ; number of 512-byte blocks allocated
   865                              <1>                at STAT_STRUC.st_atime,      dq 0 ; last access time secs
   866                              <1>                at STAT_STRUC.st_atime_nsec, dq 0 ; last access time nsecs
   867                              <1>                at STAT_STRUC.st_mtime,      dq 0 ; last modification time secs
   868                              <1>                at STAT_STRUC.st_mtime_nsec, dq 0 ; last modification time nsecs
   869                              <1>                at STAT_STRUC.st_ctime,      dq 0 ; last status changed time secs
   870                              <1>                at STAT_STRUC.st_ctime_nsec, dq 0 ; last status changed time nsecs
   871                              <1>                at STAT_STRUC._unused1,      dq 0
   872                              <1>                at STAT_STRUC._unused2,      dq 0
   873                              <1>                at STAT_STRUC._unused3,      dq 0
   874                              <1>           IEND  
   875                              <1> 
   876                              <1>           ; definition macro's for STAT structure
   877                              <1> 
   878                              <1>           %define %1.st_dev        %1+STAT_STRUC.st_dev
   879                              <1>           %define %1.st_ino        %1+STAT_STRUC.st_ino
   880                              <1>           %define %1.st_nlink      %1+STAT_STRUC.st_nlink
   881                              <1>           %define %1.st_mod        %1+STAT_STRUC.st_mod
   882                              <1>           %define %1.st_uid        %1+STAT_STRUC.st_uid
   883                              <1>           %define %1.st_gid        %1+STAT_STRUC.st_gid
   884                              <1>           %define %1.st_rdev       %1+STAT_STRUC.st_rdev
   885                              <1>          ; %define %1._pad1         %1+STAT_STRUC._pad1
   886                              <1>           %define %1.st_size       %1+STAT_STRUC.st_size
   887                              <1>           %define %1.st_blksize    %1+STAT_STRUC.st_blksize
   888                              <1>          ; %define %1._pad2         %1+STAT_STRUC._pad2
   889                              <1>           %define %1.st_blocks     %1+STAT_STRUC.st_blocks
   890                              <1>           %define %1.st_atime      %1+STAT_STRUC.st_atime
   891                              <1>           %define %1.st_atime_nsec %1+STAT_STRUC.st_atime_nsec
   892                              <1>           %define %1.st_mtime      %1+STAT_STRUC.st_mtime
   893                              <1>           %define %1.st_mtime_nsec %1+STAT_STRUC.st_mtime_nsec
   894                              <1>           %define %1.st_ctime      %1+STAT_STRUC.st_ctime
   895                              <1>           %define %1.st_ctime_nsec %1+STAT_STRUC.st_ctime_nsec
   896                              <1>          ; %define %1._unused1      %1+STAT_STRUC._unused1
   897                              <1>          ; %define %1._unused2      %1+STAT_STRUC._unused2
   898                              <1>          ; %define %1._unused3      %1+STAT_STRUC._unused3
   899                              <1>      %endmacro
   900                              <1> 
   901                              <1>      ; stat64 structure definition
   902                              <1>      ; the only structure I'm aware of today that is used in a low level programming language is the
   903                              <1>      ; STAT structure. To be complete I added stat64 structure definitions too.
   904                              <1>      ; feel free to correct it (and let me know please)
   905                              <1>      %macro STAT64 1
   906                              <1>           %1: 
   907                              <1>           ; definition macro's for STAT64 structure
   908                              <1>           %define %1.st_mode       %1+STAT_STRUC.st_mod
   909                              <1>           %define %1.st_ino        %1+STAT_STRUC.st_ino
   910                              <1>           %define %1.st_dev        %1+STAT_STRUC.st_dev
   911                              <1>           %define %1.st_nlink      %1+STAT_STRUC.st_nlink
   912                              <1>           %define %1.st_uid        %1+STAT_STRUC.st_uid
   913                              <1>           %define %1.st_gid        %1+STAT_STRUC.st_gid
   914                              <1>           %define %1.st_size       %1+STAT_STRUC.st_size
   915                              <1>           %define %1.st_atime      %1+STAT_STRUC.st_atime
   916                              <1>           %define %1.st_mtime      %1+STAT_STRUC.st_mtime
   917                              <1>           %define %1.st_ctime      %1+STAT_STRUC.st_ctime
   918                              <1>      %endmacro
   919                              <1>      
   920                              <1> %endif
   921                                  %include "sys/ipc.inc"
   922                              <1> %ifndef _ASM_IPC_INC_
   923                              <1> %define _ASM_IPC_INC_    1
   924                              <1> 
   925                              <1>      ; Mode bits for `msgget', `semget', and `shmget'.
   926                              <1>      %define IPC_CREAT   01000     ; Create key if key does not exist.
   927                              <1>      %define IPC_EXCL    02000     ; Fail if key exists.
   928                              <1>      %define IPC_NOWAIT  04000     ; Return error on wait.
   929                              <1> 
   930                              <1>      ; Control commands for `msgctl', `semctl', and `shmctl'.
   931                              <1>      %define IPC_RMID    0         ; Remove identifier.
   932                              <1>      %define IPC_SET     1         ; Set `ipc_perm' options.
   933                              <1>      %define IPC_STAT    2         ; Get `ipc_perm' options.
   934                              <1>      %define IPC_INFO    3         ; See ipcs.
   935                              <1>      ; Special key values.
   936                              <1>      %define IPC_PRIVATE 0         ; Private key.
   937                              <1> 
   938                              <1> ; Data structure used to pass permission information to IPC operations.
   939                              <1> 
   940                              <1>      STRUC IPC_PERM_STRUC
   941 00000000 <res 00000008>      <1>           .__key:             resq      1    ; Key.
   942 00000008 <res 00000008>      <1>           .uid:               resq      1    ; Owner's user ID.
   943 00000010 <res 00000008>      <1>           .gid:               resq      1    ; Owner's group ID.
   944 00000018 <res 00000008>      <1>           .cuid:              resq      1    ; Creator's user ID.
   945 00000020 <res 00000008>      <1>           .cgid:              resq      1    ; Creator's group ID.
   946 00000028 <res 00000004>      <1>           .mode:              resd      1    ; Read/write permission.
   947 0000002C <res 00000004>      <1>           .__pad1:            resd      1
   948 00000030 <res 00000004>      <1>           .__seq:             resd      1    ; Sequence number.
   949 00000034 <res 00000004>      <1>           .__pad2:            resd      1
   950 00000038 <res 00000004>      <1>           .__glibc_reserved1: resd      1
   951 0000003C <res 00000004>      <1>           .__glibc_reserved2: resd      1
   952                              <1>      ENDSTRUC
   953                              <1> 
   954                              <1>      %macro IPC_PERM 1
   955                              <1>           %1: 
   956                              <1>           ISTRUC IPC_PERM_STRUC
   957                              <1>                at IPC_PERM_STRUC.__key,                dq 0
   958                              <1>                at IPC_PERM_STRUC.uid,                  dq 0
   959                              <1>                at IPC_PERM_STRUC.gid,                  dq 0
   960                              <1>                at IPC_PERM_STRUC.cuid,                 dq 0
   961                              <1>                at IPC_PERM_STRUC.cgid,                 dq 0
   962                              <1>                at IPC_PERM_STRUC.mode,                 dd 0
   963                              <1>                at IPC_PERM_STRUC._pad1,                dd 0
   964                              <1>                at IPC_PERM_STRUC.__seg,                dd 0
   965                              <1>                at IPC_PERM_STRUC._pad2,                dd 0
   966                              <1>                at IPC_PERM_STRUC.__glibc_reserved1,    dd 0
   967                              <1>                at IPC_PERM_STRUC.__glibc_reserved2,    dd 0
   968                              <1>                
   969                              <1>           IEND  
   970                              <1> 
   971                              <1>           ; definition macro's for IPC_PERM structure
   972                              <1>           ; !! warn: Leave commented lines commented, they are here to be complete. If in the future some of these fields will be used.
   973                              <1>           
   974                              <1>           %define %1.__key              %1+IPC_PERM_STRUC.__key
   975                              <1>           %define %1.uid                %1+IPC_PERM_STRUC.uid
   976                              <1>           %define %1.gid                %1+IPC_PERM_STRUC.gid
   977                              <1>           %define %1.cuid               %1+IPC_PERM_STRUC.cuid
   978                              <1>           %define %1.cgid               %1+IPC_PERM_STRUC.cgid
   979                              <1>           %define %1.mode               %1+IPC_PERM_STRUC.mode
   980                              <1>           ; %define %1._pad1              %1+IPC_PERM_STRUC.__pad1
   981                              <1>           %define %1._seg               %1+IPC_PERM_STRUC._seg
   982                              <1>           ; %define %1._pad2              %1+IPC_PERM_STRUC.__pad2
   983                              <1>           ; %define %1.__glibc_reserved1  %1+IPC_PERM_STRUC.__glibc_reserved1
   984                              <1>           ; %define %1.__glibc_reserved2  %1+IPC_PERM_STRUC.__glibc_reserved2
   985                              <1>           
   986                              <1>      %endmacro
   987                              <1> 
   988                              <1> 
   989                              <1> 
   990                              <1> %endif     
   991                                  %include "sys/sem.inc"
   992                              <1> %ifndef _ASM_SYS_SEM_INC_
   993                              <1> %define _ASM_SYS_SEM_INC_  1
   994                              <1> 
   995                              <1> %include "sys/ipc.inc"
   996                              <2> %ifndef _ASM_IPC_INC_
   997                              <2> %define _ASM_IPC_INC_    1
   998                              <2> 
   999                              <2>      ; Mode bits for `msgget', `semget', and `shmget'.
  1000                              <2>      %define IPC_CREAT   01000     ; Create key if key does not exist.
  1001                              <2>      %define IPC_EXCL    02000     ; Fail if key exists.
  1002                              <2>      %define IPC_NOWAIT  04000     ; Return error on wait.
  1003                              <2> 
  1004                              <2>      ; Control commands for `msgctl', `semctl', and `shmctl'.
  1005                              <2>      %define IPC_RMID    0         ; Remove identifier.
  1006                              <2>      %define IPC_SET     1         ; Set `ipc_perm' options.
  1007                              <2>      %define IPC_STAT    2         ; Get `ipc_perm' options.
  1008                              <2>      %define IPC_INFO    3         ; See ipcs.
  1009                              <2>      ; Special key values.
  1010                              <2>      %define IPC_PRIVATE 0         ; Private key.
  1011                              <2> 
  1012                              <2> ; Data structure used to pass permission information to IPC operations.
  1013                              <2> 
  1014                              <2>      STRUC IPC_PERM_STRUC
  1015                              <2>           .__key:             resq      1    ; Key.
  1016                              <2>           .uid:               resq      1    ; Owner's user ID.
  1017                              <2>           .gid:               resq      1    ; Owner's group ID.
  1018                              <2>           .cuid:              resq      1    ; Creator's user ID.
  1019                              <2>           .cgid:              resq      1    ; Creator's group ID.
  1020                              <2>           .mode:              resd      1    ; Read/write permission.
  1021                              <2>           .__pad1:            resd      1
  1022                              <2>           .__seq:             resd      1    ; Sequence number.
  1023                              <2>           .__pad2:            resd      1
  1024                              <2>           .__glibc_reserved1: resd      1
  1025                              <2>           .__glibc_reserved2: resd      1
  1026                              <2>      ENDSTRUC
  1027                              <2> 
  1028                              <2>      %macro IPC_PERM 1
  1029                              <2>           %1: 
  1030                              <2>           ISTRUC IPC_PERM_STRUC
  1031                              <2>                at IPC_PERM_STRUC.__key,                dq 0
  1032                              <2>                at IPC_PERM_STRUC.uid,                  dq 0
  1033                              <2>                at IPC_PERM_STRUC.gid,                  dq 0
  1034                              <2>                at IPC_PERM_STRUC.cuid,                 dq 0
  1035                              <2>                at IPC_PERM_STRUC.cgid,                 dq 0
  1036                              <2>                at IPC_PERM_STRUC.mode,                 dd 0
  1037                              <2>                at IPC_PERM_STRUC._pad1,                dd 0
  1038                              <2>                at IPC_PERM_STRUC.__seg,                dd 0
  1039                              <2>                at IPC_PERM_STRUC._pad2,                dd 0
  1040                              <2>                at IPC_PERM_STRUC.__glibc_reserved1,    dd 0
  1041                              <2>                at IPC_PERM_STRUC.__glibc_reserved2,    dd 0
  1042                              <2>                
  1043                              <2>           IEND  
  1044                              <2> 
  1045                              <2>           ; definition macro's for IPC_PERM structure
  1046                              <2>           ; !! warn: Leave commented lines commented, they are here to be complete. If in the future some of these fields will be used.
  1047                              <2>           
  1048                              <2>           %define %1.__key              %1+IPC_PERM_STRUC.__key
  1049                              <2>           %define %1.uid                %1+IPC_PERM_STRUC.uid
  1050                              <2>           %define %1.gid                %1+IPC_PERM_STRUC.gid
  1051                              <2>           %define %1.cuid               %1+IPC_PERM_STRUC.cuid
  1052                              <2>           %define %1.cgid               %1+IPC_PERM_STRUC.cgid
  1053                              <2>           %define %1.mode               %1+IPC_PERM_STRUC.mode
  1054                              <2>           ; %define %1._pad1              %1+IPC_PERM_STRUC.__pad1
  1055                              <2>           %define %1._seg               %1+IPC_PERM_STRUC._seg
  1056                              <2>           ; %define %1._pad2              %1+IPC_PERM_STRUC.__pad2
  1057                              <2>           ; %define %1.__glibc_reserved1  %1+IPC_PERM_STRUC.__glibc_reserved1
  1058                              <2>           ; %define %1.__glibc_reserved2  %1+IPC_PERM_STRUC.__glibc_reserved2
  1059                              <2>           
  1060                              <2>      %endmacro
  1061                              <2> 
  1062                              <2> 
  1063                              <2> 
  1064                              <2> %endif     
  1065                              <1> %include "sys/time.inc"
  1066                              <2> %ifndef _ASM_TIME_INC_
  1067                              <2> %define _ASM_TIME_INC_   1
  1068                              <2> 
  1069                              <2> %define CLOCK_REALTIME 0
  1070                              <2> 
  1071                              <2> STRUC TIMESPEC_STRUC
  1072 00000000 <res 00000008>      <2>   .tv_sec:      resq    1
  1073 00000008 <res 00000008>      <2>   .tv_nsec:     resq    1
  1074                              <2> ENDSTRUC
  1075                              <2> 
  1076                              <2> STRUC TIMEVAL_STRUC
  1077 00000000 <res 00000008>      <2>   .tv_sec:      resq    1               ; seconds
  1078 00000008 <res 00000008>      <2>   .tv_usec:     resq    1               ; microseconds
  1079                              <2> ENDSTRUC
  1080                              <2> 
  1081                              <2> STRUC TIMEZONE_STRUC
  1082 00000000 <res 00000008>      <2>   .tz_minuteswest:      resq    1               ; minutes west of Greenwich
  1083 00000008 <res 00000008>      <2>   .tz_dsttime:          resq    1               ; type of DST correction
  1084                              <2> ENDSTRUC
  1085                              <2> 
  1086                              <2> 
  1087                              <2> ; TIMESPEC takes one mandatory parameter %1 which is the name of the data structure.
  1088                              <2> ; The second and third refers to secs and nanosecs respectively and aren't mandatory.
  1089                              <2> ; When no value is given for seconds and/or nanoseconds they defaults to zero.
  1090                              <2> %macro TIMESPEC 1-3 0,0
  1091                              <2>     %1:  ISTRUC TIMESPEC_STRUC
  1092                              <2>         at  TIMESPEC_STRUC.tv_sec,     dq %2
  1093                              <2>         at  TIMESPEC_STRUC.tv_nsec,    dq %3
  1094                              <2>     IEND
  1095                              <2> 
  1096                              <2>     %define %1.tv_sec   %1+TIMESPEC_STRUC.tv_sec
  1097                              <2>     %define %1.tv_nsec  %1+TIMESPEC_STRUC.tv_nsec
  1098                              <2> %endmacro
  1099                              <2> 
  1100                              <2> ; TIMEVAL takes one mandatory parameter %1 which is the name of the data structure.
  1101                              <2> ; The second and third refers to secs and microsecs respectively and aren't mandatory.
  1102                              <2> ; When no value is given for seconds and/or nanoseconds they defaults to zero.
  1103                              <2> %macro TIMEVAL 1-3 0,0
  1104                              <2>     %1:  ISTRUC TIMEVAL_STRUC
  1105                              <2>         at  TIMEVAL_STRUC.tv_sec,     dq %2
  1106                              <2>         at  TIMEVAL_STRUC.tv_usec,    dq %3
  1107                              <2>     IEND
  1108                              <2> 
  1109                              <2>     %define %1.tv_sec   %1+TIMEVAL_STRUC.tv_sec
  1110                              <2>     %define %1.tv_usec  %1+TIMEVAL_STRUC.tv_usec
  1111                              <2> %endmacro
  1112                              <2> 
  1113                              <2> ; TIMEZONE takes one mandatory parameter %1 which is the name of the data structure.
  1114                              <2> ; The second and third refers to minuteswest and dsttime respectively and aren't mandatory.
  1115                              <2> ; When no value is given for minuteswest and/or dsttime they defaults to zero.
  1116                              <2> %macro TIMEZONE 1-3 0,0
  1117                              <2>     %1:  ISTRUC TIMEZONE_STRUC
  1118                              <2>         at  TIMEZONE_STRUC.tz_minuteswest,     dq %2
  1119                              <2>         at  TIMEZONE_STRUC.tz_dsttime,         dq %3
  1120                              <2>     IEND
  1121                              <2> 
  1122                              <2>     %define %1.tz_minuteswest   %1+TIMEZONE_STRUC.tz_minuteswest
  1123                              <2>     %define %1.tz_dsttime       %1+TIMEZONE_STRUC.tz_dsttime
  1124                              <2> %endmacro
  1125                              <2> 
  1126                              <2> %endif
  1127                              <1> ; Get system dependent definition of `struct semid_ds' and more.
  1128                              <1> %define SEM_UNDO    0x1000    ; undo the operation on exit
  1129                              <1> 
  1130                              <1> ; Commands for `semctl'.
  1131                              <1> %define GETPID      11        ; get sempid
  1132                              <1> %define GETVAL      12        ; get semval
  1133                              <1> %define GETALL      13        ; get all semval's
  1134                              <1> %define GETNCNT     14        ; get semncnt
  1135                              <1> %define GETZCNT     15        ; get semzcnt
  1136                              <1> %define SETVAL      16        ; set semval
  1137                              <1> %define SETALL      17        ; set all semval's
  1138                              <1> 
  1139                              <1> 
  1140                              <1> ; Data structure describing a set of semaphores.
  1141                              <1> 
  1142                              <1> STRUC SEMID_STRUC
  1143 00000000 <res 00000008>      <1>      .sem_perm:           resq      1 ; operation permission struct, must be filled in as pointer to the structure by the calling program
  1144 00000008 <res 00000008>      <1>      .sem_otime:          resq      1 ; last semop() time
  1145 00000010 <res 00000008>      <1>      .__glibc_reserved1:  resq      1
  1146 00000018 <res 00000008>      <1>      .sem_ctime:          resq      1 ; last time changed by semctl()
  1147 00000020 <res 00000008>      <1>      .__glibc_reserved2:  resq      1 ;
  1148 00000028 <res 00000008>      <1>      .sem_nsems:          resq      1 ; number of semaphores in set
  1149 00000030 <res 00000008>      <1>      .__glibc_reserved3:  resq      1
  1150 00000038 <res 00000008>      <1>      .__glibc_reserved4:  resq      1
  1151                              <1> ENDSTRUC
  1152                              <1> 
  1153                              <1>      %macro SEMID 1
  1154                              <1>           %1: 
  1155                              <1>           ISTRUC SEMID_STRUC
  1156                              <1>                at SEMID_STRUC.sem_perm,               dq 0           ; IPC_PERM_STRUC
  1157                              <1>                at SEMID_STRUC.sem_otime,              dq 0
  1158                              <1>                at SEMID_STRUC.__glibc_reserved1,      dq 0
  1159                              <1>                at SEMID_STRUC.sem_ctime,              dq 0
  1160                              <1>                at SEMID_STRUC.__glibc_reserved2,      dq 0
  1161                              <1>                at SEMID_STRUC.sem_nsems,              dd 0
  1162                              <1>                at SEMID_STRUC.__glibc_reserved3,      dq 0
  1163                              <1>                at SEMID_STRUC.__glibc_reserved4,      dq 0
  1164                              <1>           IEND  
  1165                              <1> 
  1166                              <1>           ; definition macro's for SEM_ID structure
  1167                              <1>           ; !! warn: Leave commented lines commented, they are here to be complete. If in the future some of these fields will be used.
  1168                              <1>           
  1169                              <1>           %define %1.perm                  %1+SEMID_STRUC.sem_perm
  1170                              <1>           %define %1.perm.uid              %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.uid
  1171                              <1>           %define %1.perm.gid              %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.gid
  1172                              <1>           %define %1.perm.cuid             %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.cuid
  1173                              <1>           %define %1.perm.cgid             %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.cgid
  1174                              <1>           %define %1.perm.mode             %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.mode
  1175                              <1>           %define %1.perm.__seq            %1+SEMID_STRUC.sem_perm+IPC_PERM_STRUC.__seq
  1176                              <1> 
  1177                              <1>           %define %1.sem_otime                    %1+SEMID_STRUC.sem_otime
  1178                              <1>           ; %define %1.sem_id__glibc_reserved1    %1+SEMID_STRUC.sem_id__glibc_reserved1
  1179                              <1>           %define %1.sem_ctime                    %1+SEMID_STRUC.sem_ctime
  1180                              <1>           ; %define %1.sem_id__glibc_reserved2    %1+SEMID_STRUC.sem_id__glibc_reserved2
  1181                              <1>           %define %1.sem_nsems                    %1+SEMID_STRUC.sem_nsems
  1182                              <1>           ; %define %1.sem_id__glibc_reserved3    %1+SEMID_STRUC.sem_id__glibc_reserved3
  1183                              <1>           ; %define %1.sem_id__glibc_reserved4    %1+SEMID_STRUC.sem_id__glibc_reserved4
  1184                              <1>           
  1185                              <1>      %endmacro
  1186                              <1> 
  1187                              <1>      ; ipcs ctl cmds
  1188                              <1>      %define SEM_STAT                       18
  1189                              <1>      %define SEM_INFO                       19
  1190                              <1> 
  1191                              <1>      STRUC SEMINFO_STRUC
  1192 00000000 <res 00000008>      <1>           semmap:        resq      1
  1193 00000008 <res 00000008>      <1>           semmni:        resq      1
  1194 00000010 <res 00000008>      <1>           semmns:        resq      1
  1195 00000018 <res 00000008>      <1>           semmnu:        resq      1
  1196 00000020 <res 00000008>      <1>           semmsl:        resq      1
  1197 00000028 <res 00000008>      <1>           semopm:        resq      1
  1198 00000030 <res 00000008>      <1>           semume:        resq      1
  1199 00000038 <res 00000008>      <1>           semusz:        resq      1
  1200 00000040 <res 00000008>      <1>           semvmx:        resq      1
  1201 00000048 <res 00000008>      <1>           semaem:        resq      1
  1202                              <1>      ENDSTRUC
  1203                              <1> 
  1204                              <1>      %macro SEMINFO 1
  1205                              <1>           %1: 
  1206                              <1>           ISTRUC SEMINFO_STRUC
  1207                              <1>                at   SEMINFO_STRUC.semmap,         dq   0
  1208                              <1>                at   SEMINFO_STRUC.semmni,         dq   0
  1209                              <1>                at   SEMINFO_STRUC.semmns,         dq   0
  1210                              <1>                at   SEMINFO_STRUC.semmnu,         dq   0
  1211                              <1>                at   SEMINFO_STRUC.semmls,         dq   0
  1212                              <1>                at   SEMINFO_STRUC.semopm,         dq   0
  1213                              <1>                at   SEMINFO_STRUC.semume,         dq   0
  1214                              <1>                at   SEMINFO_STRUC.semusz,         dq   0
  1215                              <1>                at   SEMINFO_STRUC.semvmx,         dq   0
  1216                              <1>                at   SEMINFO_STRUC.semaem,         dq   0
  1217                              <1>           IEND
  1218                              <1> 
  1219                              <1>           %define %1.semmap.      %1+SEMINFO_STRUC.semmap
  1220                              <1>           %define %1.semmni.      %1+SEMINFO_STRUC.semmni
  1221                              <1>           %define %1.semmns.      %1+SEMINFO_STRUC.semmns
  1222                              <1>           %define %1.semmnu.      %1+SEMINFO_STRUC.semmnu
  1223                              <1>           %define %1.semmls.      %1+SEMINFO_STRUC.semmls
  1224                              <1>           %define %1.semopm.      %1+SEMINFO_STRUC.semopm
  1225                              <1>           %define %1.semume.      %1+SEMINFO_STRUC.semume
  1226                              <1>           %define %1.semusz.      %1+SEMINFO_STRUC.semusz
  1227                              <1>           %define %1.semvmx.      %1+SEMINFO_STRUC.semvmx
  1228                              <1>           %define %1.semaem.      %1+SEMINFO_STRUC.semaem
  1229                              <1> 
  1230                              <1>      %endmacro
  1231                              <1> 
  1232                              <1>      ; Structure used for argument to `semop' to describe operations.
  1233                              <1> 
  1234                              <1>      STRUC SEMBUF_STRUC
  1235 00000000 <res 00000008>      <1>           .sem_num:      resq      1
  1236 00000008 <res 00000008>      <1>           .sem_op:       resq      1
  1237 00000010 <res 00000008>      <1>           .sem_flg:      resq      1
  1238                              <1>      ENDSTRUC
  1239                              <1> 
  1240                              <1>      %macro SEMBUF 1
  1241                              <1>           %1:
  1242                              <1>           ISTRUC SEMBUF_STRUC
  1243                              <1>                at   SEMBUF_STRUC.sem_num,         dq   0
  1244                              <1>                at   SEMBUF_STRUC.sem_op,          dq   0
  1245                              <1>                at   SEMBUF_STRUC.sem_flg,         dq   0
  1246                              <1>           IEND
  1247                              <1> 
  1248                              <1>           %define %1.sem_num        %1+SEMBUF_STRUC.sem_num
  1249                              <1>           %define %1.sem_op        %1+SEMBUF_STRUC.sem_op
  1250                              <1>           %define %1.sem_flg       %1+SEMBUF_STRUC.sem_flg
  1251                              <1>      %endmacro
  1252                              <1> %endif
  1253                                  
  1254                                  section .data
  1255 00000000 0000000000000000             key:           dq        0
  1256 00000008 0000000000000000             semid:         dq        0
  1257 00000010 2E2F73656D64656D6F-          file:          db        "./semdemo", 0
  1258 00000019 00                 
  1259                                       STAT           stat
  1260                              <1>  %1:
  1261                              <1>  ISTRUC STAT_STRUC
  1262 0000001A 0000000000000000    <1>  at STAT_STRUC.st_dev, dq 0
  1263 00000022 0000000000000000    <1>  at STAT_STRUC.st_ino, dq 0
  1264 0000002A 0000000000000000    <1>  at STAT_STRUC.st_nlink, dq 0
  1265 00000032 00000000            <1>  at STAT_STRUC.st_mod, dd 0
  1266 00000036 00000000            <1>  at STAT_STRUC.st_uid, dd 0
  1267 0000003A 00000000            <1>  at STAT_STRUC.st_gid, dd 0
  1268 0000003E 0000000000000000    <1>  at STAT_STRUC.st_rdev, dq 0
  1269 00000046 00000000            <1>  at STAT_STRUC._pad1, dd 0
  1270 0000004A 0000000000000000    <1>  at STAT_STRUC.st_size, dq 0
  1271 00000052 00000000            <1>  at STAT_STRUC.st_blksize, dd 0
  1272 00000056 00000000            <1>  at STAT_STRUC._pad2, dd 0
  1273 0000005A 0000000000000000    <1>  at STAT_STRUC.st_blocks, dq 0
  1274 00000062 0000000000000000    <1>  at STAT_STRUC.st_atime, dq 0
  1275 0000006A 0000000000000000    <1>  at STAT_STRUC.st_atime_nsec, dq 0
  1276 00000072 0000000000000000    <1>  at STAT_STRUC.st_mtime, dq 0
  1277 0000007A 0000000000000000    <1>  at STAT_STRUC.st_mtime_nsec, dq 0
  1278 00000082 0000000000000000    <1>  at STAT_STRUC.st_ctime, dq 0
  1279 0000008A 0000000000000000    <1>  at STAT_STRUC.st_ctime_nsec, dq 0
  1280 00000092 0000000000000000    <1>  at STAT_STRUC._unused1, dq 0
  1281 0000009A 0000000000000000    <1>  at STAT_STRUC._unused2, dq 0
  1282 000000A2 0000000000000000    <1>  at STAT_STRUC._unused3, dq 0
  1283                              <1>  IEND
  1284                              <1> 
  1285                              <1> 
  1286                              <1> 
  1287                              <1>  %define %1.st_dev %1+STAT_STRUC.st_dev
  1288                              <1>  %define %1.st_ino %1+STAT_STRUC.st_ino
  1289                              <1>  %define %1.st_nlink %1+STAT_STRUC.st_nlink
  1290                              <1>  %define %1.st_mod %1+STAT_STRUC.st_mod
  1291                              <1>  %define %1.st_uid %1+STAT_STRUC.st_uid
  1292                              <1>  %define %1.st_gid %1+STAT_STRUC.st_gid
  1293                              <1>  %define %1.st_rdev %1+STAT_STRUC.st_rdev
  1294                              <1> 
  1295                              <1>  %define %1.st_size %1+STAT_STRUC.st_size
  1296                              <1>  %define %1.st_blksize %1+STAT_STRUC.st_blksize
  1297                              <1> 
  1298                              <1>  %define %1.st_blocks %1+STAT_STRUC.st_blocks
  1299                              <1>  %define %1.st_atime %1+STAT_STRUC.st_atime
  1300                              <1>  %define %1.st_atime_nsec %1+STAT_STRUC.st_atime_nsec
  1301                              <1>  %define %1.st_mtime %1+STAT_STRUC.st_mtime
  1302                              <1>  %define %1.st_mtime_nsec %1+STAT_STRUC.st_mtime_nsec
  1303                              <1>  %define %1.st_ctime %1+STAT_STRUC.st_ctime
  1304                              <1>  %define %1.st_ctime_nsec %1+STAT_STRUC.st_ctime_nsec
  1305                              <1> 
  1306                              <1> 
  1307                              <1> 
  1308 000000AA 63616E6E6F74206765-          semgeterror:   db   "cannot get semaphore.", 10
  1309 000000B3 742073656D6170686F-
  1310 000000BC 72652E0A           
  1311                                       .length:       equ  $-semgeterror
  1312 000000C0 4552524F522053454D-          semctlerror:   db   "ERROR SEMCTL", 10
  1313 000000C9 43544C0A           
  1314                                       .length:       equ  $-semctlerror
  1315 000000CD 63616E6E6F74206765-          ftokerror:     db   "cannot get IPC key from ftok function", 10
  1316 000000D6 7420495043206B6579-
  1317 000000DF 2066726F6D2066746F-
  1318 000000E8 6B2066756E6374696F-
  1319 000000F1 6E0A               
  1320                                       .length:       equ  $-ftokerror
  1321                                       
  1322                                  section .text
  1323                                  global _start
  1324                                  _start:
  1325                                  
  1326 00000000 48BF-                        mov       rdi, file                                    ; path to file
  1327 00000002 [1000000000000000] 
  1328 0000000A BE4A000000                   mov       rsi, 'J'                                     ; proj_id
  1329 0000000F E8CA000000                   call      ftok
  1330 00000014 48890425[00000000]           mov       qword[key], rax                              ; save the retrieved key
  1331 0000001C 4885C0                       test      rax, rax
  1332 0000001F 786F                         js        error.ftok                                   ; on error just exit, just because we are lazy in this example
  1333                                       
  1334                                       ; grab the semaphore set created by seminit.c
  1335 00000021 4831D2BE0100000048-          syscall   semget, qword[key], 1, 0                     ; just get the semid, don't create one
  1336 0000002A 8B3C25[00000000]B8-
  1337 00000032 400000000F05       
  1338 00000038 48890425[08000000]           mov       qword[semid], rax                            ; save the semid
  1339 00000040 4885C0                       test      rax, rax
  1340 00000043 7824                         js        error.semget                                 ; on error just exit, just because we are lazy in this example
  1341                                       
  1342                                       ; remove it
  1343 00000045 4831D24831F6488B3C-          syscall   semctl, qword[semid], 0, IPC_RMID            ; no union semun because op IPC_RMID (see man page)
  1344 0000004E 25[08000000]B84200-
  1345 00000056 00000F05           
  1346                                       ; don't test rax, we just leave the program error or not
  1347 0000005A 4885C0                       test      rax, rax
  1348 0000005D 7858                         js        error.semctl
  1349                                       
  1350                                  exit:
  1351 0000005F 4831FFB83C0000000F-          syscall   exit, 0
  1352 00000068 05                 
  1353                                  
  1354                                  error:
  1355                                  .semget:
  1356 00000069 BA1600000048BE-              syscall   write, stderr, semgeterror, semgeterror.length
  1357 00000070 [AA00000000000000]-
  1358 00000078 BF02000000B8010000-
  1359 00000081 000F05             
  1360 00000084 BF01000000B83C0000-          syscall   exit, 1
  1361 0000008D 000F05             
  1362                                  .ftok:
  1363 00000090 BA2600000048BE-              syscall   write, stderr, ftokerror, ftokerror.length
  1364 00000097 [CD00000000000000]-
  1365 0000009F BF02000000B8010000-
  1366 000000A8 000F05             
  1367 000000AB BF01000000B83C0000-          syscall   exit, 1
  1368 000000B4 000F05             
  1369                                  .semctl:
  1370 000000B7 BA0D00000048BE-              syscall   write, stderr, semctlerror, semctlerror.length
  1371 000000BE [C000000000000000]-
  1372 000000C6 BF02000000B8010000-
  1373 000000CF 000F05             
  1374 000000D2 BF01000000B83C0000-          syscall   exit, 1
  1375 000000DB 000F05             
  1376                                  
  1377                                  ftok:
  1378                                       ; source: http://beej.us/guide/bgipc/output/html/multipage/mq.html
  1379                                       ; the type key_t is actually just a long, you can use any number you want. But what if you hard-code the number and some other unrelated
  1380                                       ; program hardcodes the same number but wants another queue? The solution is to use the ftok() function which generates a key from two arguments:
  1381                                       ; key_t ftok(const char *path, int id);
  1382                                       ;
  1383                                       ; RDI has the path/file string to the file
  1384                                       ; RSI has an 'project id' arbitrary choosen.
  1385                                       ; on return: RAX has a unique key
  1386                                       ; on failure: RAX = a negative number containing the error
  1387                                       ; key = ((st.st_ino & 0xffff) | ((st.st_dev & 0xff) << 16) | ((proj_id & 0xff) << 24));
  1388                                  
  1389                                       ; save the project id in R8 (will remain after syscalls)
  1390                                  
  1391 000000DE 4989F0                       mov       r8, rsi
  1392                                       ; open the file
  1393 000000E1 4831F6B8020000000F-          syscall   open, rdi, O_RDONLY
  1394 000000EA 05                 
  1395 000000EB 4821C0                       and       rax, rax
  1396 000000EE 784B                         js        .done
  1397 000000F0 48BE-                        syscall   fstat, rax, stat
  1398 000000F2 [1A00000000000000]-
  1399 000000FA 4889C7B8050000000F-
  1400 00000103 05                 
  1401 00000104 4821C0                       and       rax, rax
  1402 00000107 7832                         js        .done
  1403 00000109 488B0425[22000000]           mov       rax, QWORD [stat.st_ino]                ; get the file size
  1404 00000111 4825FFFF0000                 and       rax, 0xFFFF
  1405 00000117 488B1C25[1A000000]           mov       rbx, QWORD [stat.st_dev]
  1406 0000011F 4881E3FF000000               and       rbx, 0xFF
  1407 00000126 48C1E310                     shl       rbx, 16
  1408 0000012A 4809D8                       or        rax, rbx
  1409 0000012D 4981E0FF000000               and       r8, 0xFF                                ; R8 = proj_id
  1410 00000134 49C1E018                     shl       r8, 24
  1411 00000138 4C09C0                       or        rax, r8
  1412                                       ; rax now contains a key which uniquely identifies the file.
  1413                                  .done:     
  1414 0000013B C3                           ret
