; GTKAPP Class
; .
; Definition op a gtk application.  Each gtk app should start with this.

%ifndef _GTKAPP_CLASS_
%define _GTKAPP_CLASS_

	extern  gtk_init
	extern  gtk_main
	extern  gtk_main_quit
	extern  exit

    STRUC GTKAPP_STRUC
		.onInitFail			resq	1
		.onInitSuccess		resq 	1
		.onBeforeRun		resq	1
		.onAfterRun			resq	1
		.onExit				resq 	1
		.Exit				resq	1
		.Init				resq	1
		.Run				resq 	1
    ENDSTRUC

    %macro GTKAPP 1
		%ifndef GTKAPPMACROS
		%define GTKAPPMACROS

			%macro GTKAPPRUN 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.Run
				call    qword[rax]
			%endmacro

			%macro GTKAPPINIT 1
				mov 	rcx,%1								;this pointer in rcx
				;call	initialization function
				mov 	rax, %1+GTKAPP_STRUC.Init
				call    qword[rax]
			%endmacro
			
			%macro GTKAPPEXIT 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.Exit
				call    qword[rax]
			%endmacro
			
			%macro GTKAPPONINITFAIL 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.onInitFail
				mov 	[rax],rdi
			%endmacro
			
			%macro GTKAPPONINITSUCCESS 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.onInitSuccess
				mov 	[rax],rdi
			%endmacro
			
			%macro	GTKAPPONBEFORERUN 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.onBeforeRun
				mov 	[rax],rdi
			%endmacro
			
			%macro	GTKAPPONAFTERRUN 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.onAfterRun
				mov 	[rax],rdi
			%endmacro
			
			%macro	GTKAPPONEXIT 1
				mov 	rcx,%1								;this pointer in rcx
				mov 	rax,%1+GTKAPP_STRUC.onExit
				mov 	[rax],rdi
			%endmacro

		%endif    
		
		%define %1.onInitFail		GTKAPPONINITFAIL	%1
		%define %1.onInitSuccess	GTKAPPONINITSUCCESS	%1
		%define %1.onBeforeRun		GTKAPPONBEFORERUN	%1
		%define %1.onAfterRun		GTKAPPONAFTERRUN	%1
		%define %1.onExit			GTKAPPONEXIT		%1
		%define %1.Run				GTKAPPRUN 			%1
		%define %1.Init				GTKAPPINIT 			%1
		%define %1.Exit				GTKAPPEXIT			%1
		
		[section .data]
		%1: ISTRUC GTKAPP_STRUC
				at	GTKAPP_STRUC.onInitFail,	dq	0
				at	GTKAPP_STRUC.onInitSuccess,	dq	0
				at	GTKAPP_STRUC.onBeforeRun,	dq	0
				at	GTKAPP_STRUC.onAfterRun,	dq	0
				at	GTKAPP_STRUC.onExit,		dq	0
				at  GTKAPP_STRUC.Exit,			dq	GTKAPPExit
				at  GTKAPP_STRUC.Init,			dq	GTKAPPInit
				at  GTKAPP_STRUC.Run,			dq	GTKAPPRun
			IEND   
    %endmacro
	
	section .text
	GTKAPPInit:
		push	rbp
		mov 	rbp,rsp
	;	sub		rsp,8
		xor		rdi,rdi						;pointer to argc = null for now
		xor		rsi,rsi						;pointer to argv = null for now
		call	gtk_init
		;if rax = 0 then gtk_init fails
		and 	rax,rax
		jnz		..@done
		xor 	rdi,rdi
		call 	exit
	..@done:
		; here we initialize the window
		; we don't show it yet
		mov		rsp,rbp
		pop		rbp
		ret									;rax has the window handler
		
	GTKAPPRun:
		push	rbp
		mov 	rbp,rsp
	;	sub 	rsp,8
	;	here we show the window and enter the window message loop
		call    gtk_main
		mov 	rsp,rbp
		pop 	rbp
		ret
				
	GTKAPPExit:
		push 	rbp
		mov 	rbp,rsp
		; here we perform maintenance actions and close the application
		xor     rdi,rdi
		call    exit
%endif
